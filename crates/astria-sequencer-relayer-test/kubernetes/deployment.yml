apiVersion: apps/v1
kind: Deployment
metadata:
  name: sequencer-relayer-environment-deployment
  labels:
    app: sequencer-relayer-environment
spec:
  replicas: 1
  selector:
    matchLabels:
      app: sequencer-relayer-environment
  template:
    metadata:
      labels:
        app: sequencer-relayer-environment
    spec:
      securityContext:
        fsGroup: 10001
        fsGroupChangePolicy: "OnRootMismatch"
      initContainers:
        - command:
          - /scripts/init-celestia-appd.sh
          name: init-celestia-app
          image: "ghcr.io/celestiaorg/celestia-app:v1.0.0-rc7"
          volumeMounts:
            - mountPath: /scripts
              name: celestia-appd-scripts-volume
              readOnly: true
            - mountPath: /home/celestia
              name: celestia-home
          envFrom:
            - configMapRef:
                name: sequencer-relayer-environment-celestia-config
        - command:
          - /scripts/init-bridge.sh
          name: init-bridge
          image: "ghcr.io/astriaorg/test-images-celestia-node:v0.11.0-rc7"
          volumeMounts:
            - mountPath: /scripts/
              name: bridge-scripts-volume
              readOnly: true
            - mountPath: /home/celestia
              name: celestia-home
          envFrom:
            - configMapRef:
                name: sequencer-relayer-environment-celestia-config
        - command:
          - /home/cometbft/cometbft init
          name: init-cometbft
          image: "ghcr.io/noot99/cometbft:latest"
      containers:
        - name: celestia-app
          command: ["/scripts/start-celestia-appd.sh"]
          image: "ghcr.io/celestiaorg/celestia-app:v1.0.0-rc7"
          envFrom:
            - configMapRef:
                name: sequencer-relayer-environment-celestia-config
          volumeMounts:
          - mountPath: /scripts/
            name: celestia-appd-scripts-volume
            readOnly: true
          - mountPath: /home/celestia
            name: celestia-home
        - name: celestia-bridge
          command:
          - /scripts/start-bridge.sh
          image: "ghcr.io/astriaorg/test-images-celestia-node:v0.11.0-rc7"
          volumeMounts:
            - mountPath: /scripts/
              name: bridge-scripts-volume
              readOnly: true
            - mountPath: /home/celestia
              name: celestia-home
          envFrom:
            - configMapRef:
                name: sequencer-relayer-environment-celestia-config
          ports:
            - containerPort: 26659
              name: bridge-rest
            - containerPort: 26658
              name: bridge-jsonrpc
          startupProbe:
            httpGet:
              path: /header/1
              port: bridge-rest
            failureThreshold: 30
            periodSeconds: 10
          lifecycle:
            postStart:
              exec:
                command: ["/scripts/generate-token.sh"]
        - name: astria-sequencer
          image: docker.io/library/debian:bookworm-slim
          command: ["/usr/local/bin/astria-sequencer"] # TODO genesis state?
          volumeMounts:
            - mountPath: /usr/local/bin/astria-sequencer
              name: astria-sequencer-binary
              readOnly: true
          ports:
            - containerPort: 26658
              name: sequencer-svc
        #   startupProbe:
        #     httpGet:
        #       path: /blocks
        #       port: sequencer-svc
        #     failureThreshold: 30
        #     periodSeconds: 10
        - name: cometbft
          command: ["/home/cometbft/cometbft start"]
          image: "ghcr.io/noot99/cometbft:latest"
          ports:
            - containerPort: 26657
              name: cometbft-svc
      volumes:
      - name: astria-sequencer-binary
        hostPath:
          path: /tmp/astria/astria-sequencer
          type: File
      - name: bridge-scripts-volume
        configMap:
          name: bridge-scripts
          defaultMode: 0500
      - name: celestia-appd-scripts-volume
        configMap:
          name: celestia-appd-scripts
          defaultMode: 0500
      - emptyDir: {}
        name: celestia-home
