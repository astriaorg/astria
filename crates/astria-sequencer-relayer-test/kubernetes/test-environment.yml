apiVersion: v1
data:
  generate-token.sh: |
    #!/bin/sh -x
    celestia bridge auth admin \
      --node.store "$home_dir/bridge" \
      --keyring.accname validator > "$home_dir"/.admin_token
  init-bridge.sh: |
    #!/bin/sh -x

    set -o errexit -o nounset

    celestia bridge init \
      --node.store "$home_dir/bridge" \
      --core.ip 127.0.0.1
    cp -r "$home_dir/keyring-test" "$home_dir/bridge/keys/"
  start-bridge.sh: "#!/bin/sh -x\n\nset -o errexit -o nounset -o pipefail\n\nif genesis_hash=$(curl
    -s -S -X GET \"http://127.0.0.1:26657/block?height=1\" | jq -er '.result.block_id.hash');\nthen\n
    \ : \"genesis hash received successfully\"\nelse\n  echo \"did not receive genesis
    hash from celestia; exiting\"\n  exit 1\nfi\n\necho \"using genesis hash: $genesis_hash\"\n\nexport
    GOLOG_LOG_LEVEL=\"debug\"\nexport CELESTIA_CUSTOM=\"test:$genesis_hash\"\nexec
    celestia bridge start \\\n  --node.store \"$home_dir/bridge\" \\\n  --gateway
    \\\n  --keyring.accname \"$validator_key_name\" \\ \n  --rpc.port 26690\n"
kind: ConfigMap
metadata:
  name: bridge-scripts-6tbc68f5cc
---
apiVersion: v1
data:
  init-celestia-appd.sh: |
    #!/bin/sh -x

    set -o errexit -o nounset

    rm -rf "$home_dir"/*

    celestia-appd init "$chainid" \
      --chain-id "$chainid" \
      --home "$home_dir"

    celestia-appd keys add \
      "$validator_key_name" \
      --keyring-backend="$keyring_backend" \
      --home "$home_dir"

    validator_key=$(celestia-appd keys show "$validator_key_name" -a --keyring-backend="$keyring_backend" --home "$home_dir")
    celestia-appd add-genesis-account \
      "$validator_key" \
      --home "$home_dir" \
      "$coins"

    celestia-appd gentx \
      "$validator_key_name" \
      "$validator_stake" \
      --keyring-backend="$keyring_backend" \
      --chain-id "$chainid" \
      --home "$home_dir" \
      --evm-address "$evm_address"

    celestia-appd collect-gentxs --home "$home_dir"
    sed -i'.bak' 's/timeout_commit = "25s"/timeout_commit = "1s"/g' $home_dir/config/config.toml
  start-celestia-appd.sh: |
    #!/bin/sh

    set -o errexit -o nounset

    # Start the celestia-app
    exec celestia-appd start --home "${home_dir}"
kind: ConfigMap
metadata:
  name: celestia-appd-scripts-4k665bchh4
---
apiVersion: v1
data:
  chainid: test
  coins: 1000000000000000utia
  evm_address: 0x966e6f22781EF6a6A82BBB4DB3df8E225DfD9488
  home_dir: /home/celestia
  keyring_backend: test
  validator_key_name: validator
  validator_stake: 5000000000utia
kind: ConfigMap
metadata:
  name: sequencer-relayer-environment-celestia-config
---
apiVersion: v1
kind: Service
metadata:
  name: sequencer-relayer-environment-service
spec:
  ports:
  - name: cometbft-svc
    port: 26657
    targetPort: cometbft-svc
  - name: sequencer-svc
    port: 26658
    targetPort: sequencer-svc
  - name: bridge-rest
    port: 26659
    targetPort: bridge-rest
  - name: bridge-jsonrpc
    port: 26690
    targetPort: bridge-jsonrpc
  selector:
    app: sequencer-relayer-environment
---
apiVersion: apps/v1
kind: Deployment
metadata:
  labels:
    app: sequencer-relayer-environment
  name: sequencer-relayer-environment-deployment
spec:
  replicas: 1
  selector:
    matchLabels:
      app: sequencer-relayer-environment
  template:
    metadata:
      labels:
        app: sequencer-relayer-environment
    spec:
      containers:
      - command:
        - /scripts/start-celestia-appd.sh
        envFrom:
        - configMapRef:
            name: sequencer-relayer-environment-celestia-config
        image: ghcr.io/celestiaorg/celestia-app:v1.0.0-rc7
        name: celestia-app
        volumeMounts:
        - mountPath: /scripts/
          name: celestia-appd-scripts-volume
          readOnly: true
        - mountPath: /home/celestia
          name: celestia-home
      - command:
        - /scripts/start-bridge.sh
        envFrom:
        - configMapRef:
            name: sequencer-relayer-environment-celestia-config
        image: ghcr.io/astriaorg/test-images-celestia-node:v0.11.0-rc7
        lifecycle:
          postStart:
            exec:
              command:
              - /scripts/generate-token.sh
        name: celestia-bridge
        ports:
        - containerPort: 26659
          name: bridge-rest
        - containerPort: 26690
          name: bridge-jsonrpc
        startupProbe:
          failureThreshold: 30
          httpGet:
            path: /header/1
            port: bridge-rest
          periodSeconds: 10
        volumeMounts:
        - mountPath: /scripts/
          name: bridge-scripts-volume
          readOnly: true
        - mountPath: /home/celestia
          name: celestia-home
      - command:
        - /usr/local/bin/astria-sequencer
        image: docker.io/library/debian:bookworm-slim
        name: astria-sequencer
        ports:
        - containerPort: 26658
          name: sequencer-svc
        volumeMounts:
        - mountPath: /usr/local/bin/astria-sequencer
          name: astria-sequencer-binary
          readOnly: true
      - command:
        - /home/cometbft/cometbft start
        image: ghcr.io/astriaorg/cometbft:0.0.2
        name: cometbft
        ports:
        - containerPort: 26657
          name: cometbft-svc
      initContainers:
      - command:
        - /scripts/init-celestia-appd.sh
        envFrom:
        - configMapRef:
            name: sequencer-relayer-environment-celestia-config
        image: ghcr.io/celestiaorg/celestia-app:v1.0.0-rc7
        name: init-celestia-app
        volumeMounts:
        - mountPath: /scripts
          name: celestia-appd-scripts-volume
          readOnly: true
        - mountPath: /home/celestia
          name: celestia-home
      - command:
        - /scripts/init-bridge.sh
        envFrom:
        - configMapRef:
            name: sequencer-relayer-environment-celestia-config
        image: ghcr.io/astriaorg/test-images-celestia-node:v0.11.0-rc7
        name: init-bridge
        volumeMounts:
        - mountPath: /scripts/
          name: bridge-scripts-volume
          readOnly: true
        - mountPath: /home/celestia
          name: celestia-home
      - command:
        - /home/cometbft/cometbft init
        image: ghcr.io/astriaorg/cometbft:0.0.2
        name: init-cometbft
      securityContext:
        fsGroup: 10001
        fsGroupChangePolicy: OnRootMismatch
      volumes:
      - hostPath:
          path: /tmp/astria/astria-sequencer
          type: File
        name: astria-sequencer-binary
      - configMap:
          defaultMode: 320
          name: bridge-scripts-6tbc68f5cc
        name: bridge-scripts-volume
      - configMap:
          defaultMode: 320
          name: celestia-appd-scripts-4k665bchh4
        name: celestia-appd-scripts-volume
      - emptyDir: {}
        name: celestia-home
