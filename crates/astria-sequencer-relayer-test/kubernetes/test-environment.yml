apiVersion: v1
data:
  init-bridge.sh: |
    #!/bin/sh

    set -o errexit -o nounset

    ./celestia bridge init \
      --node.store "$home_dir/bridge" \
      --core.ip 127.0.0.1
    cp -r "$home_dir/keyring-test" "$home_dir/bridge/keys/"
  start-bridge.sh: |
    #!/bin/bash

    set -o errexit -o nounset -o pipefail

    genesis_hash=$(curl -s -S -X GET "http://127.0.0.1:26657/block?height=1" | jq -r '.result.block_id.hash')
    if [ -z "$genesis_hash" ]
    then
      echo "did not receive genesis hash from celestia; exiting"
      exit 1
    else
      echo "genesis hash received: $genesis_hash"
    fi

    export CELESTIA_CUSTOM="test:$genesis_hash"
      # --p2p.network "test:$celestia_custom"
    export GOLOG_LOG_LEVEL="debug"
    exec ./celestia bridge start \
      --node.store "$home_dir/bridge" \
      --gateway \
      --keyring.accname "$validator_key_name"
kind: ConfigMap
metadata:
  name: bridge-scripts-tctfb6gktd
---
apiVersion: v1
data:
  init-celestia-appd.sh: |
    #!/bin/sh

    set -o errexit -o nounset

    celestia-appd init "$chainid" \
      --chain-id "$chainid" \
      --home "$home_dir"

    celestia-appd keys add \
      "$validator_key_name" \
      --keyring-backend="$keyring_backend" \
      --home "$home_dir"

    validator_key=`celestia-appd keys show "$validator_key_name" -a --keyring-backend="$keyring_backend" --home "$home_dir"`
    celestia-appd add-genesis-account \
      "$validator_key" \
      --home "$home_dir" \
      "$coins"

    celestia-appd gentx \
      "$validator_key_name" \
      "$validator_stake" \
      --keyring-backend="$keyring_backend" \
      --chain-id "$chainid" \
      --home "$home_dir" \
      --orchestrator-address "$validator_key" \
      --evm-address "$evm_address"

    celestia-appd collect-gentxs --home "$home_dir"
  start-celestia-appd.sh: |
    #!/bin/sh

    set -o errexit -o nounset

    # Start the celestia-app
    exec celestia-appd start --home "${home_dir}"
kind: ConfigMap
metadata:
  name: celestia-appd-scripts-mgmh8g995k
---
apiVersion: v1
data:
  chainid: test
  coins: 1000000000000000utia
  evm_address: 0x966e6f22781EF6a6A82BBB4DB3df8E225DfD9488
  home_dir: /home/celestia
  keyring_backend: test
  validator_key_name: validator
  validator_stake: 5000000000utia
kind: ConfigMap
metadata:
  name: sequencer-relayer-environment-celestia-config
---
apiVersion: v1
kind: Service
metadata:
  name: sequencer-relayer-environment-service
spec:
  ports:
  - name: cometbft-svc
    port: 26657
    targetPort: cometbft-svc
  - name: sequencer-svc
    port: 26658
    targetPort: sequencer-svc
  - name: bridge-svc
    port: 26659
    targetPort: bridge-svc
  selector:
    app: sequencer-relayer-environment
---
apiVersion: apps/v1
kind: Deployment
metadata:
  labels:
    app: sequencer-relayer-environment
  name: sequencer-relayer-environment-deployment
spec:
  replicas: 1
  selector:
    matchLabels:
      app: sequencer-relayer-environment
  template:
    metadata:
      labels:
        app: sequencer-relayer-environment
    spec:
      containers:
      - command:
        - /scripts/start-celestia-appd.sh
        envFrom:
        - configMapRef:
            name: sequencer-relayer-environment-celestia-config
        image: ghcr.io/astriaorg/celestia-app:v0.11.0
        name: celestia-app
        volumeMounts:
        - mountPath: /scripts/
          name: celestia-appd-scripts-volume
          readOnly: true
        - mountPath: /home/celestia
          name: celestia-home
      - command:
        - /scripts/start-bridge.sh
        envFrom:
        - configMapRef:
            name: sequencer-relayer-environment-celestia-config
        image: ghcr.io/astriaorg/celestia-node:test-sha-07fa3e7
        name: celestia-bridge
        ports:
        - containerPort: 26659
          name: bridge-svc
        startupProbe:
          failureThreshold: 30
          httpGet:
            path: /header/1
            port: bridge-svc
          periodSeconds: 10
        volumeMounts:
        - mountPath: /scripts/
          name: bridge-scripts-volume
          readOnly: true
        - mountPath: /home/celestia
          name: celestia-home
      - command:
        - /usr/local/bin/astria-sequencer
        image: docker.io/library/debian:bookworm-slim
        name: astria-sequencer
        ports:
        - containerPort: 26658
          name: sequencer-svc
        volumeMounts:
        - mountPath: /usr/local/bin/astria-sequencer
          name: astria-sequencer-binary
          readOnly: true
      - command:
        - /home/cometbft/cometbft start
        image: ghcr.io/noot99/cometbft:latest
        name: cometbft
        ports:
        - containerPort: 26657
          name: cometbft-svc
      initContainers:
      - command:
        - /scripts/init-celestia-appd.sh
        envFrom:
        - configMapRef:
            name: sequencer-relayer-environment-celestia-config
        image: ghcr.io/astriaorg/celestia-app:v0.11.0
        name: init-celestia-app
        volumeMounts:
        - mountPath: /scripts
          name: celestia-appd-scripts-volume
          readOnly: true
        - mountPath: /home/celestia
          name: celestia-home
      - command:
        - /scripts/init-bridge.sh
        envFrom:
        - configMapRef:
            name: sequencer-relayer-environment-celestia-config
        image: ghcr.io/astriaorg/celestia-node:test-sha-07fa3e7
        name: init-bridge
        volumeMounts:
        - mountPath: /scripts/
          name: bridge-scripts-volume
          readOnly: true
        - mountPath: /home/celestia
          name: celestia-home
      - command:
        - /home/cometbft/cometbft init
        image: ghcr.io/noot99/cometbft:latest
        name: init-cometbft
      volumes:
      - hostPath:
          path: /tmp/astria/astria-sequencer
          type: File
        name: astria-sequencer-binary
      - configMap:
          defaultMode: 320
          name: bridge-scripts-tctfb6gktd
        name: bridge-scripts-volume
      - configMap:
          defaultMode: 320
          name: celestia-appd-scripts-mgmh8g995k
        name: celestia-appd-scripts-volume
      - emptyDir: {}
        name: celestia-home
