use astria_core::protocol::{
    abci::AbciErrorCode,
    asset::v1::AllowedFeeAssetsResponse,
};
use cnidarium::Storage;
use prost::Message as _;
use tendermint::abci::{
    request,
    response,
    Code,
};

use super::StateReadExt as _;
use crate::app::StateReadExt as _;

/// Returns a query response containing a `Vec` of all the currently allowed fee assets in their
/// `IbcPrefixed` form.
pub(crate) async fn allowed_fee_assets_request(
    storage: Storage,
    request: request::Query,
    _params: Vec<(String, String)>,
) -> response::Query {
    // get last snapshot
    let snapshot = storage.latest_snapshot();

    // get height from snapshot
    let height = match snapshot.get_block_height().await {
        Ok(height) => height,
        Err(err) => {
            return response::Query {
                code: Code::Err(AbciErrorCode::INTERNAL_ERROR.value()),
                info: AbciErrorCode::INTERNAL_ERROR.info(),
                log: format!("failed getting block height: {err:#}"),
                ..response::Query::default()
            };
        }
    };

    // get ids from snapshot at height
    let fee_assets = match snapshot.get_allowed_fee_assets().await {
        Ok(fee_assets) => fee_assets,
        Err(err) => {
            return response::Query {
                code: Code::Err(AbciErrorCode::INTERNAL_ERROR.value()),
                info: AbciErrorCode::INTERNAL_ERROR.info(),
                log: format!("failed to retrieve allowed fee assets: {err:#}"),
                ..response::Query::default()
            };
        }
    };

    let payload = AllowedFeeAssetsResponse {
        height,
        fee_assets: fee_assets.into_iter().map(Into::into).collect(),
    }
    .into_raw()
    .encode_to_vec()
    .into();

    let height = tendermint::block::Height::try_from(height).expect("height must fit into an i64");
    response::Query {
        code: tendermint::abci::Code::Ok,
        key: request.path.into_bytes().into(),
        value: payload,
        height,
        ..response::Query::default()
    }
}
